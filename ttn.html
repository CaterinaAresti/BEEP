<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>TTN tester</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="ttn-payload-decoder.js"></script>
        <script src="ttn-payload-converter.js"></script>
        <style type="text/css">
            textarea{
                font-family: courier;
            }
        </style>
    </head>
    <body>
        <h1>BEEP base fw 1.3.2 BLE control point and LoRaWAN test commands</h1>
    	<p>Set FFT to mic with signal on tip (IN2LP), +20dB, 10 bins, 98-586 Hz: 8B0228000A0946</p>
    	<p>(Re)set LoRaWAN on, DutyCycle limitation on, ADR on: 940D</p>
    	<p>Set LoRaWAN off, DutyCycle limitation off, ADR off: 9400</p>
    	<p>Set Measurement interval to 1 min, 1 min send: 9D000001</p>
    	<p>Set Measurement interval to 1 min, 3 min send: 9D030001</p>
        <p>Set Measurement interval to 5 min, 15 min send: 9D030005</p>
    	<p>Set Measurement interval to 10 min, 10 min send: 9D01000A</p>

        <h1>Payload tester</h1>
        <p>uses ttn-payload-decoder.js and ttn-payload-converter.js</p>
        <input id="payload-input" type="text" name="payload" max="100" style="width: 70%;" value="1B0C100C03640A01FFF55A04020AE90AF00C0A00FF004D00100010000D000C000B0009000A0007000707000000000000" onchange="test()">
        <input id="payload-port" type="number" name="port" min="0" max="9" value="3" onchange="test()">
        <button onclick="test()">TEST</button>
        <h3>Payload HEX:</h3>
        <textarea id="payload-spaced" cols="140" rows="2"></textarea>

        <h3>ByteArray HEX:</h3>
        <textarea id="bytearray" cols="140" rows="2"></textarea>
        <h3>Decoder test result:</h3>
        <textarea id="decoder-result" cols="100" rows="10"></textarea>
        <h3>Converter test result:</h3>
        <textarea id="converter-result" cols="100" rows="10"></textarea>

        <script>
            function test()
            {
                var port      = document.getElementById("payload-port").value;
                var bytes     = document.getElementById("payload-input").value;
                
                var payload_spaced  = "";
                var payload_count   = "";
                var byteArray       = new Uint8Array(bytes.length/2);
                var byteMem         = "0x";

                for(i=0 ; i < bytes.length+2 ; i++)
                {
                    if (i % 2 == 0 && i != 0)
                    {
                        var index = (i/2) - 1;
                        payload_spaced += " ";
                        payload_count  += index;
                        byteArray.fill(byteMem, index, index+1);
                        byteMem = "0x";
                    }

                    if (i < bytes.length)
                    {
                        payload_spaced += bytes[i];
                        byteMem += bytes[i];
                    }

                    if (i > 1 && (i < 22 || i % 2 == 0))
                        payload_count  += " ";
                }
                payload_spaced = payload_spaced + "\n" + payload_count;

                var decoded   = Decoder(byteArray, port);
                var converted = Converter(decoded, port);
                console.log('decoded', decoded);
                console.log('converted', converted);
                document.getElementById("bytearray").innerHTML = byteArray;
                document.getElementById("payload-spaced").innerHTML = payload_spaced;
                document.getElementById("decoder-result").innerHTML = JSON.stringify(decoded);
                document.getElementById("converter-result").innerHTML = JSON.stringify(converted);
            }
        </script>
    </body>
</html>